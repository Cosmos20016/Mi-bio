---
interface Props {
  toolName: string;
  toolDescription: string;
  toolUrl: string;
}

const { toolName, toolDescription, toolUrl } = Astro.props;
const uniqueId = `share-btn-${Math.random().toString(36).slice(2, 11)}`;
---

<div class="share-tool-button-wrapper">
  <button
    id={uniqueId}
    class="share-tool-button"
    aria-label="Compartir herramienta"
    data-tool-name={toolName}
    data-tool-description={toolDescription}
    data-tool-url={toolUrl}
  >
    <svg class="share-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="18" cy="5" r="3"></circle>
      <circle cx="6" cy="12" r="3"></circle>
      <circle cx="18" cy="19" r="3"></circle>
      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
    </svg>
    <span>Compartir</span>
  </button>
</div>

<!-- El popup se crea en JS y se inserta en <body> (patrÃ³n portal) para
     escapar de cualquier overflow:hidden del layout padre. -->

<script>
  let shareAbortController: AbortController | null = null;

  function closeAllPopups() {
    document.querySelectorAll<HTMLElement>('.share-popup-portal').forEach((p) => {
      p.classList.remove('share-popup-visible');
    });
  }

  /** Posiciona el popup fixed justo debajo del botÃ³n (solo desktop). */
  function positionPopup(popup: HTMLElement, btn: HTMLButtonElement) {
    const r   = btn.getBoundingClientRect();
    const w   = 300;
    const gap = 8;
    popup.style.top  = `${r.bottom + gap}px`;
    popup.style.left = `${Math.max(8, Math.min(r.right - w, window.innerWidth - w - 8))}px`;
  }

  function initShareButtons() {
    if (shareAbortController) shareAbortController.abort();
    shareAbortController = new AbortController();
    const signal = shareAbortController.signal;

    document.querySelectorAll<HTMLButtonElement>('.share-tool-button').forEach((buttonElement) => {
      const buttonId = buttonElement.id;

      // Eliminar popup previo de este botÃ³n (re-init tras navegaciÃ³n)
      document.getElementById(`${buttonId}-popup`)?.remove();

      // â”€â”€ Crear popup y aÃ±adirlo a <body> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const popup = document.createElement('div');
      popup.id        = `${buttonId}-popup`;
      popup.className = 'share-popup-portal';
      popup.setAttribute('role', 'dialog');
      popup.setAttribute('aria-modal', 'true');

      // Copiar --hue del elemento raÃ­z para que oklch() funcione en el portal
      const rootHue = getComputedStyle(document.documentElement).getPropertyValue('--hue').trim();
      if (rootHue) popup.style.setProperty('--hue', rootHue);

      const syncTheme = () => {
        popup.classList.toggle('dark', document.documentElement.classList.contains('dark'));
        // Re-sync --hue por si cambiÃ³
        const hue = getComputedStyle(document.documentElement).getPropertyValue('--hue').trim();
        if (hue) popup.style.setProperty('--hue', hue);
      };
      syncTheme();

      popup.innerHTML = `
        <div class="spp-inner">
          <button class="spp-option" data-platform="whatsapp" aria-label="WhatsApp">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#25D366">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
            </svg>
            <span>WhatsApp</span>
          </button>

          <button class="spp-option" data-platform="facebook" aria-label="Facebook">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#1877F2">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
            <span>Facebook</span>
          </button>

          <button class="spp-option" data-platform="twitter" aria-label="X (Twitter)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="spp-twitter-icon">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            <span>X (Twitter)</span>
          </button>

          <button class="spp-option" data-platform="telegram" aria-label="Telegram">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#0088cc">
              <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
            </svg>
            <span>Telegram</span>
          </button>

          <button class="spp-option spp-copy-btn" data-platform="copy" aria-label="Copiar enlace">
            <svg class="spp-copy-default" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <svg class="spp-copy-check" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:none">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <span class="spp-copy-text">Copiar enlace</span>
          </button>
        </div>
      `;

      document.body.appendChild(popup);

      // â”€â”€ Datos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const toolName        = buttonElement.dataset.toolName        || '';
      const toolDescription = buttonElement.dataset.toolDescription || '';
      const toolUrl         = buttonElement.dataset.toolUrl         || '';
      const absoluteUrl     = `${window.location.origin}${toolUrl}`;
      const shareText       = `Â¡Mira esta herramienta gratuita: ${toolName}! ${toolDescription} ðŸš€`;

      const isMobile       = () => window.innerWidth <= 640;
      // FIX mÃ³vil: solo activar share nativo si la API estÃ¡ disponible Y
      // el navegador realmente puede manejar el tipo de contenido.
      // Algunos navegadores (Samsung Internet, WebView) tienen canShare() pero
      // navigator.share() falla sin lanzar error â†’ usamos un wrapper con timeout.
      const hasNativeShare = 'share' in navigator && typeof navigator.canShare === 'function';

      // â”€â”€ Abrir / Cerrar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const closePopup = () => popup.classList.remove('share-popup-visible');

      const openPopup = () => {
        closeAllPopups();
        syncTheme();
        if (!isMobile()) positionPopup(popup, buttonElement);
        popup.classList.add('share-popup-visible');
      };

      // Reposicionar al hacer scroll / resize (desktop)
      window.addEventListener('scroll', () => {
        if (popup.classList.contains('share-popup-visible') && !isMobile()) {
          positionPopup(popup, buttonElement);
        }
      }, { signal, passive: true });

      window.addEventListener('resize', () => {
        if (popup.classList.contains('share-popup-visible') && !isMobile()) {
          positionPopup(popup, buttonElement);
        }
      }, { signal });

      // â”€â”€ BotÃ³n principal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      buttonElement.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        // Intentar share nativo en mÃ³vil con timeout de seguridad.
        // Si en 500ms no se abriÃ³ el diÃ¡logo nativo, mostramos el popup.
        if (isMobile() && hasNativeShare) {
          const shareData = { title: toolName, text: shareText, url: absoluteUrl };
          if (navigator.canShare(shareData)) {
            let nativeWorked = false;
            const timeoutId = setTimeout(() => {
              // Share nativo no se activÃ³ â†’ mostrar popup de fallback
              if (!nativeWorked) openPopup();
            }, 500);

            try {
              await navigator.share(shareData);
              nativeWorked = true;
              clearTimeout(timeoutId);
              return; // Ã‰xito
            } catch (err) {
              nativeWorked = true; // Evitar que el timeout abra el popup tambiÃ©n
              clearTimeout(timeoutId);
              // AbortError = usuario cancelÃ³ â†’ no hacer nada mÃ¡s
              if (err instanceof Error && err.name === 'AbortError') return;
              // Cualquier otro error â†’ mostrar popup
            }
          }
        }

        popup.classList.contains('share-popup-visible') ? closePopup() : openPopup();
      }, { signal });

      // â”€â”€ Opciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      popup.querySelectorAll<HTMLElement>('.spp-option').forEach((option) => {
        option.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();

          const platform = option.dataset.platform;

          switch (platform) {
            case 'whatsapp':
              window.open(`https://wa.me/?text=${encodeURIComponent(`${shareText} ${absoluteUrl}`)}`, '_blank', 'noopener,noreferrer');
              closePopup();
              break;
            case 'facebook':
              window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(absoluteUrl)}`, '_blank', 'noopener,noreferrer');
              closePopup();
              break;
            case 'twitter':
              window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(absoluteUrl)}&text=${encodeURIComponent(shareText)}`, '_blank', 'noopener,noreferrer');
              closePopup();
              break;
            case 'telegram':
              window.open(`https://t.me/share/url?url=${encodeURIComponent(absoluteUrl)}&text=${encodeURIComponent(shareText)}`, '_blank', 'noopener,noreferrer');
              closePopup();
              break;
            case 'copy': {
              const copyText    = option.querySelector<HTMLElement>('.spp-copy-text')!;
              const iconDefault = option.querySelector<SVGElement>('.spp-copy-default')!;
              const iconCheck   = option.querySelector<SVGElement>('.spp-copy-check')!;

              const showSuccess = () => {
                copyText.textContent      = 'Â¡Copiado!';
                iconDefault.style.display = 'none';
                iconCheck.style.display   = 'block';
                option.style.background   = 'oklch(0.95 0.05 145)';
                setTimeout(() => {
                  copyText.textContent      = 'Copiar enlace';
                  iconDefault.style.display = '';
                  iconCheck.style.display   = 'none';
                  option.style.background   = '';
                }, 2000);
              };

              try {
                await navigator.clipboard.writeText(absoluteUrl);
                showSuccess();
              } catch {
                try {
                  const ta = document.createElement('textarea');
                  ta.value = absoluteUrl;
                  ta.style.cssText = 'position:fixed;opacity:0;pointer-events:none;top:0;left:0';
                  document.body.appendChild(ta);
                  ta.focus(); ta.select();
                  const ok = document.execCommand('copy');
                  document.body.removeChild(ta);
                  ok ? showSuccess() : alert('No se pudo copiar el enlace');
                } catch {
                  alert('No se pudo copiar el enlace');
                }
              }
              break;
            }
          }
        }, { signal });
      });

      // â”€â”€ Cerrar al hacer clic fuera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.addEventListener('click', (e) => {
        const t = e.target as HTMLElement;
        if (
          popup.classList.contains('share-popup-visible') &&
          !t.closest('.share-tool-button-wrapper') &&
          !t.closest('.share-popup-portal')
        ) {
          closePopup();
        }
      }, { signal });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePopup();
      }, { signal });
    });
  }

  function cleanupPopups() {
    document.querySelectorAll('.share-popup-portal').forEach((p) => p.remove());
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initShareButtons);
  } else {
    initShareButtons();
  }

  document.addEventListener('astro:before-preparation', cleanupPopups);
  document.addEventListener('astro:page-load', initShareButtons);
  document.addEventListener('swup:page:view', initShareButtons);
</script>

<style>
  .share-tool-button-wrapper {
    position: relative;
    display: inline-flex;
  }

  .share-tool-button {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 0.3rem 0.65rem;
    border-radius: 9999px;
    background: oklch(0.93 0.04 var(--hue));
    color: oklch(0.45 0.14 var(--hue));
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    touch-action: manipulation;
  }

  :global(.dark) .share-tool-button {
    background: oklch(0.3 0.05 var(--hue));
    color: oklch(0.82 0.12 var(--hue));
  }

  .share-tool-button:hover {
    background: oklch(0.88 0.06 var(--hue));
    color: oklch(0.45 0.16 var(--hue));
    transform: scale(1.05);
  }

  :global(.dark) .share-tool-button:hover {
    background: oklch(0.35 0.07 var(--hue));
    color: oklch(0.85 0.14 var(--hue));
  }

  .share-tool-button:active { transform: scale(0.95); }
  .share-icon { width: 14px; height: 14px; }
</style>

<!-- is:global porque el popup vive en <body>, fuera del scope del componente -->
<style is:global>
  /* â”€â”€ Portal popup base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .share-popup-portal {
    position: fixed;
    width: 300px;
    /* Colores originales con oklch + --hue (inyectado por JS desde :root) */
    background: oklch(0.99 0.005 var(--hue, 250));
    border-radius: 1rem;
    padding: 0.75rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.10), 0 2px 8px rgba(0,0,0,0.06);
    z-index: 99999;
    opacity: 0;
    transform: translateY(-8px) scale(0.97);
    transition: opacity 0.18s ease, transform 0.18s ease, visibility 0s linear 0.18s;
    pointer-events: none;
    visibility: hidden;
  }

  /* Dark mode: mismos valores que el original */
  .share-popup-portal.dark {
    background: oklch(0.19 0.015 var(--hue, 250));
    box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.08);
  }

  .share-popup-portal.share-popup-visible {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
    visibility: visible;
    transition: opacity 0.18s ease, transform 0.18s ease;
  }

  /* â”€â”€ Grid de opciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .spp-inner {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }

  .spp-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.45rem;
    padding: 0.875rem 0.4rem;
    border: none;
    border-radius: 0.75rem;
    background: oklch(0.96 0.01 var(--hue, 250));
    cursor: pointer;
    transition: background 0.15s ease, transform 0.15s ease;
    font-size: 0.7rem;
    font-weight: 600;
    color: #475569;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    touch-action: manipulation;
    white-space: nowrap;
  }

  .share-popup-portal.dark .spp-option {
    background: oklch(0.24 0.02 var(--hue, 250));
    color: #cbd5e1;
  }

  .spp-option:hover {
    background: oklch(0.92 0.02 var(--hue, 250));
    transform: translateY(-2px);
  }

  .share-popup-portal.dark .spp-option:hover {
    background: oklch(0.28 0.03 var(--hue, 250));
  }

  .spp-option:active { transform: translateY(0); }

  .spp-twitter-icon { color: #14171A; }
  .share-popup-portal.dark .spp-twitter-icon { color: #E7E9EA; }

  .spp-copy-btn {
    color: oklch(0.5 0.14 var(--hue, 250));
  }
  .share-popup-portal.dark .spp-copy-btn {
    color: oklch(0.75 0.12 var(--hue, 250));
  }

  /* â”€â”€ Mobile: bottom sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 640px) {
    .share-popup-portal {
      position: fixed !important;
      top: auto !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      width: 100% !important;
      max-width: 100%;
      border-radius: 1.25rem 1.25rem 0 0;
      /* Espacio extra para la home bar en iPhone/Android */
      padding: 1.25rem 1rem calc(1.5rem + env(safe-area-inset-bottom));
      max-height: 72vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      /* Slide desde abajo */
      transform: translateY(110%) !important;
      transition: transform 0.28s cubic-bezier(0.32, 0.72, 0, 1), opacity 0.15s ease, visibility 0s linear 0.28s;
    }

    .share-popup-portal.share-popup-visible {
      transform: translateY(0) !important;
      opacity: 1;
      visibility: visible;
      transition: transform 0.28s cubic-bezier(0.32, 0.72, 0, 1), opacity 0.15s ease;
    }

    .spp-inner {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.625rem;
    }

    .spp-option {
      padding: 1rem 0.5rem;
      min-height: 76px;
      font-size: 0.75rem;
    }
  }
</style>
