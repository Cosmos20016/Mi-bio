---
import path from "node:path";
import License from "@components/misc/License.astro";
import Markdown from "@components/misc/Markdown.astro";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getSortedPosts } from "@utils/content-utils";
import { getDir, getPostUrlBySlug } from "@utils/url-utils";
import { Icon } from "astro-icon/components";
import { licenseConfig } from "src/config";
import ImageWrapper from "../../components/misc/ImageWrapper.astro";
import PostMetadata from "../../components/PostMeta.astro";
import { profileConfig, siteConfig } from "../../config";
import { formatDateToYYYYMMDD } from "../../utils/date-utils";

export async function getStaticPaths() {
    const blogEntries = await getSortedPosts();
    return blogEntries.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

const { entry } = Astro.props;

const renderResult = await entry.render();
const { Content, headings } = renderResult;
const { remarkPluginFrontmatter } = renderResult;

const jsonLd = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: entry.data.title,
    description: entry.data.description || entry.data.title,
    keywords: entry.data.tags,
    image: entry.data.image
        ? new URL(
                entry.data.image.startsWith("/")
                    ? entry.data.image
                    : `/${entry.data.image}`,
                Astro.site,
            ).href
        : new URL("/og-default.png", Astro.site).href,
    author: {
        "@type": "Person",
        name: profileConfig.name,
        url: Astro.site?.toString(),
    },
    publisher: {
        "@type": "Person",
        name: profileConfig.name,
        url: Astro.site?.toString(),
    },
    datePublished: formatDateToYYYYMMDD(entry.data.published),
    dateModified: entry.data.updated
        ? formatDateToYYYYMMDD(entry.data.updated)
        : formatDateToYYYYMMDD(entry.data.published),
    mainEntityOfPage: {
        "@type": "WebPage",
        "@id": new URL(`/posts/${entry.slug}/`, Astro.site).href,
    },
    inLanguage: entry.data.lang
        ? entry.data.lang.replace("_", "-")
        : siteConfig.lang.replace("_", "-"),
};

const nextUrl = entry.data.nextSlug ? getPostUrlBySlug(entry.data.nextSlug) : null;
const prevUrl = entry.data.prevSlug ? getPostUrlBySlug(entry.data.prevSlug) : null;
---

<MainGridLayout
    banner={entry.data.image}
    title={entry.data.title}
    description={entry.data.description}
    lang={entry.data.lang}
    setOGTypeArticle={true}
    headings={headings}
>
    <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>

    <article
        class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4"
        itemscope
        itemtype="https://schema.org/BlogPosting"
    >
        <div
            id="post-container"
            class:list={["card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full", {}]}
        >
            <div
                class="flex flex-row text-black/30 dark:text-white/30 gap-5 mb-3 transition onload-animation"
                role="complementary"
                aria-label="Información del artículo"
            >
                <div class="flex flex-row items-center">
                    <div
                        class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
                        aria-hidden="true"
                    >
                        <Icon name="material-symbols:notes-rounded"></Icon>
                    </div>
                    <div class="text-sm">
                        <span itemprop="wordCount">{remarkPluginFrontmatter.words}</span>
                        {" " + i18n(I18nKey.wordsCount)}
                    </div>
                </div>
                <div class="flex flex-row items-center">
                    <div
                        class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
                        aria-hidden="true"
                    >
                        <Icon name="material-symbols:schedule-outline-rounded"></Icon>
                    </div>
                    <div class="text-sm">
                        <span itemprop="timeRequired" content={`PT${remarkPluginFrontmatter.minutes}M`}>
                            {remarkPluginFrontmatter.minutes}
                        </span>
                        {" " + i18n(remarkPluginFrontmatter.minutes === 1 ? I18nKey.minuteCount : I18nKey.minutesCount)}
                    </div>
                </div>
            </div>

            <header class="relative onload-animation">
                <h1
                    data-pagefind-body
                    data-pagefind-weight="10"
                    data-pagefind-meta="title"
                    itemprop="headline"
                    class="transition w-full block font-bold mb-3
                    text-3xl md:text-[2.25rem]/[2.75rem]
                    text-black/90 dark:text-white/90
                    md:before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)]
                    before:absolute before:top-[0.75rem] before:left-[-1.125rem]"
                >
                    {entry.data.title}
                </h1>
            </header>

            <div class="onload-animation">
                <PostMetadata
                    class="mb-5"
                    published={entry.data.published}
                    updated={entry.data.updated}
                    tags={entry.data.tags}
                    category={entry.data.category}
                ></PostMetadata>
                {!entry.data.image && (
                    <div class="border-[var(--line-divider)] border-dashed border-b-[1px] mb-5"></div>
                )}
            </div>

            {entry.data.image && (
                <ImageWrapper
                    id="post-cover"
                    src={entry.data.image}
                    basePath={path.join("content/posts/", getDir(entry.id))}
                    class="mb-8 rounded-xl banner-container onload-animation"
                    itemprop="image"
                />
            )}

            <div itemprop="articleBody">
                <Markdown class="mb-6 markdown-content onload-animation">
                    <Content />
                </Markdown>
            </div>

            {licenseConfig.enable && (
                <License
                    title={entry.data.title}
                    slug={entry.slug}
                    pubDate={entry.data.published}
                    class="mb-6 rounded-xl license-container onload-animation"
                ></License>
            )}
        </div>
    </article>

    <nav
        class="flex flex-col md:flex-row justify-between mb-4 gap-4 overflow-hidden w-full"
        aria-label="Navegación entre artículos"
    >
        {nextUrl ? (
            <a
                href={nextUrl}
                class="w-full font-bold overflow-hidden active:scale-95 transition-transform"
                aria-label={`Anterior: ${entry.data.nextTitle}`}
                rel="prev"
            >
                <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-start gap-4">
                    <Icon
                        name="material-symbols:chevron-left-rounded"
                        class="text-[2rem] text-[var(--primary)] flex-shrink-0"
                        aria-hidden="true"
                    />
                    <span class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
                        {entry.data.nextTitle}
                    </span>
                </div>
            </a>
        ) : (
            <div class="w-full" aria-hidden="true"></div>
        )}

        {prevUrl ? (
            <a
                href={prevUrl}
                class="w-full font-bold overflow-hidden active:scale-95 transition-transform"
                aria-label={`Siguiente: ${entry.data.prevTitle}`}
                rel="next"
            >
                <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-end gap-4">
                    <span class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
                        {entry.data.prevTitle}
                    </span>
                    <Icon
                        name="material-symbols:chevron-right-rounded"
                        class="text-[2rem] text-[var(--primary)] flex-shrink-0"
                        aria-hidden="true"
                    />
                </div>
            </a>
        ) : (
            <div class="w-full" aria-hidden="true"></div>
        )}
    </nav>

    <section
        id="giscus-container"
        transition:name="giscus"
        transition:animate="none"
        class="card-base rounded-[var(--radius-large)] px-6 md:px-9 py-6 mt-6"
        aria-label="Comentarios del artículo"
    ></section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         PROTECCIÓN DE CONTENIDO
         1. Atribución automática al copiar
         2. Bloqueo de atajos de teclado de DevTools
         3. Marca de agua en imágenes del artículo
    ════════════════════════════════════════════════════════════════════════ -->
    <script is:inline>
        (function () {
            'use strict';

            /* ── 1. ATRIBUCIÓN AUTOMÁTICA AL COPIAR ──────────────────────────
               Permite copiar libremente pero añade la fuente al final del
               texto copiado. Solo aplica dentro del cuerpo del artículo
               para no interferir con otras partes de la página (nav, código, etc.).
            ─────────────────────────────────────────────────────────────────── */
            var SITE_URL    = 'Kevinborja.com';
            var ATTRIBUTION = '\n\n— Extraído de ' + SITE_URL;
            var MIN_CHARS   = 80; // umbral: atribuye solo selecciones significativas

            document.addEventListener('copy', function (e) {
                var articleBody = document.querySelector('[itemprop="articleBody"]');
                if (!articleBody) return;

                var selection = window.getSelection();
                if (!selection || selection.isCollapsed) return;

                // Verificar que la selección esté DENTRO del cuerpo del artículo
                // (evita añadir atribución al copiar desde nav, footer o comentarios)
                var anchorNode = selection.anchorNode;
                if (!anchorNode) return;
                var anchorEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
                if (!articleBody.contains(anchorEl)) return;

                var selectedText = selection.toString();
                if (selectedText.trim().length < MIN_CHARS) return; // citas cortas: sin atribución

                // Versión enriquecida para pegar en editores con formato
                var htmlAttribution =
                    '<br><br><em>— Extraído de <a href="https://' +
                    SITE_URL + '">' + SITE_URL + '</a></em>';

                try {
                    e.clipboardData.setData('text/plain', selectedText + ATTRIBUTION);
                    e.clipboardData.setData(
                        'text/html',
                        '<span>' + selectedText.replace(/\n/g, '<br>') + '</span>' + htmlAttribution
                    );
                    e.preventDefault();
                } catch (_) {
                    // Si el navegador no permite manipular el clipboard (poco probable),
                    // simplemente dejamos pasar el evento original sin error.
                }
            });

            /* ── 2. BLOQUEO DE ATAJOS DE TECLADO DE DEVTOOLS ─────────────────
               Atajos bloqueados:
                 · F12
                 · Ctrl/Cmd + Shift + I  (Elements / Sources)
                 · Ctrl/Cmd + Shift + J  (Console)
                 · Ctrl/Cmd + Shift + C  (Inspector de elementos)
                 · Ctrl/Cmd + U          (Ver código fuente)
               El click derecho NO se toca: solo se bloquea la apertura
               de DevTools por teclado, sin afectar la experiencia del usuario.
            ─────────────────────────────────────────────────────────────────── */
            document.addEventListener('keydown', function (e) {
                var key  = e.key;
                var ctrl = e.ctrlKey || e.metaKey; // compatible macOS (Cmd) y Windows (Ctrl)

                // F12
                if (key === 'F12') {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }

                // Ctrl/Cmd + Shift + I / J / C
                if (ctrl && e.shiftKey) {
                    var upper = key.toUpperCase();
                    if (upper === 'I' || upper === 'J' || upper === 'C') {
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }
                }

                // Ctrl/Cmd + U  (ver fuente)
                if (ctrl && key.toUpperCase() === 'U') {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }, true); // captura en fase de captura para mayor fiabilidad

            /* ── 3. MARCA DE AGUA EN IMÁGENES ────────────────────────────────
               Técnica: reemplaza cada <img> del artículo por un <canvas>
               con la imagen pintada + marca de agua superpuesta.
               Al guardar con "click derecho → Guardar imagen" o arrastrar,
               el usuario obtiene la versión con marca de agua, nunca el original.

               Comportamiento en pantalla: la marca sutil diagonal es casi
               imperceptible durante la lectura; la etiqueta de esquina la hace
               visible solo al examinarla con atención o al descargar.

               Limitación CORS: imágenes externas (CDN distinto) necesitan el
               header "Access-Control-Allow-Origin: *" en el servidor de origen
               para poder pintarse en canvas. Las imágenes del propio dominio
               funcionan siempre sin configuración extra.
            ─────────────────────────────────────────────────────────────────── */
            var WM_TEXT    = '© Kevinborja.com';
            var WM_PADDING = 12; // px desde el borde inferior-derecho

            function drawWatermark(ctx, w, h) {
                ctx.save();

                // ── Texto diagonal centrado (muy sutil, apenas visible al leer) ──
                ctx.font        = 'bold ' + Math.max(12, Math.round(w * 0.022)) + 'px sans-serif';
                ctx.globalAlpha = 0.18;
                ctx.fillStyle   = '#ffffff';
                ctx.translate(w / 2, h / 2);
                ctx.rotate(-Math.PI / 6);
                ctx.textAlign    = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(WM_TEXT, 0, 0);
                ctx.restore();

                ctx.save();
                // ── Etiqueta sólida esquina inferior-derecha ───────────────────
                ctx.font         = 'bold 13px sans-serif';
                ctx.textAlign    = 'right';
                ctx.textBaseline = 'bottom';
                var x = w - WM_PADDING;
                var y = h - WM_PADDING;
                // Pill de fondo semitransparente para legibilidad
                var metrics  = ctx.measureText(WM_TEXT);
                var tw       = metrics.width;
                var th       = 18;
                var rx       = x - tw - 8;
                var ry       = y - th + 2;
                var rw       = tw + 16;
                var rh       = th + 4;
                var radius   = 4;
                ctx.globalAlpha = 0.55;
                ctx.fillStyle   = '#000000';
                ctx.beginPath();
                ctx.moveTo(rx + radius, ry);
                ctx.lineTo(rx + rw - radius, ry);
                ctx.quadraticCurveTo(rx + rw, ry, rx + rw, ry + radius);
                ctx.lineTo(rx + rw, ry + rh - radius);
                ctx.quadraticCurveTo(rx + rw, ry + rh, rx + rw - radius, ry + rh);
                ctx.lineTo(rx + radius, ry + rh);
                ctx.quadraticCurveTo(rx, ry + rh, rx, ry + rh - radius);
                ctx.lineTo(rx, ry + radius);
                ctx.quadraticCurveTo(rx, ry, rx + radius, ry);
                ctx.closePath();
                ctx.fill();
                // Texto blanco sobre el pill
                ctx.globalAlpha = 1;
                ctx.fillStyle   = 'rgba(255,255,255,0.92)';
                ctx.fillText(WM_TEXT, x, y);
                ctx.restore();
            }

            function protectImage(img) {
                if (img.dataset.wmProtected) return;
                img.dataset.wmProtected = '1';

                var canvas = document.createElement('canvas');
                var ctx    = canvas.getContext('2d');
                if (!ctx) return; // guarda: el navegador no soporta canvas 2D

                function render() {
                    var w = img.naturalWidth  || img.width  || 800;
                    var h = img.naturalHeight || img.height || 600;

                    canvas.width  = w;
                    canvas.height = h;

                    // Clonar estilos del <img> original para que encaje en el layout
                    canvas.className      = img.className;
                    canvas.style.cssText  = img.style.cssText;
                    canvas.style.maxWidth = '100%';
                    canvas.style.height   = 'auto';
                    canvas.style.display  = img.style.display || 'block';
                    canvas.style.cursor   = 'default';
                    canvas.setAttribute('role',       'img');
                    canvas.setAttribute('aria-label', img.alt || 'Imagen del artículo');

                    // Bloquear arrastre y menú contextual solo sobre esta imagen
                    canvas.addEventListener('dragstart',   function (e) { e.preventDefault(); });
                    canvas.addEventListener('contextmenu', function (e) { e.preventDefault(); });

                    ctx.drawImage(img, 0, 0, w, h);
                    drawWatermark(ctx, w, h);

                    if (img.parentNode) {
                        img.parentNode.replaceChild(canvas, img);
                    }
                }

                if (img.complete && img.naturalWidth > 0) {
                    render();
                } else {
                    img.addEventListener('load', render);
                    img.addEventListener('error', function () {
                        // Si la carga falla solo bloqueamos arrastre y contextmenu en el <img>
                        img.addEventListener('dragstart',   function (e) { e.preventDefault(); });
                        img.addEventListener('contextmenu', function (e) { e.preventDefault(); });
                    });
                    if (!img.src) return;
                    var src = img.src;
                    img.crossOrigin = 'anonymous';
                    img.src = '';
                    img.src = src;
                }
            }

            function protectAllImages() {
                var articleBody = document.querySelector('[itemprop="articleBody"]');
                if (!articleBody) return;
                articleBody.querySelectorAll('img').forEach(function (img) {
                    // Ignorar el cover del post (está fuera del articleBody pero por si acaso)
                    if (img.id === 'post-cover') return;
                    // Ignorar iconos pequeños: usar naturalWidth si ya cargó,
                    // o el atributo width/height del HTML como fallback para imágenes no cargadas.
                    // img.width (CSS rendered) puede ser 0 antes de la carga, por eso no es fiable.
                    var intrinsicW = img.naturalWidth
                        || parseInt(img.getAttribute('width') || '0', 10)
                        || 0;
                    if (intrinsicW > 0 && intrinsicW < 100) return;
                    img.crossOrigin = 'anonymous';
                    protectImage(img);
                });
            }

            // Bandera para evitar doble ejecución en carga inicial:
            // tanto DOMContentLoaded/inline como astro:page-load disparan al inicio.
            var _imagesProtectedOnLoad = false;

            function protectAllImagesOnce() {
                if (_imagesProtectedOnLoad) { _imagesProtectedOnLoad = false; return; }
                _imagesProtectedOnLoad = true;
                protectAllImages();
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', protectAllImages);
            } else {
                // Carga directa: ejecutar ahora y marcar para saltarse el astro:page-load inicial
                _imagesProtectedOnLoad = true;
                protectAllImages();
            }
            // Re-ejecutar en navegaciones SPA de Astro (View Transitions).
            // En la carga inicial, astro:page-load llega milisegundos después del bloque anterior;
            // la bandera evita procesarlas dos veces.
            document.addEventListener('astro:page-load', function () {
                if (_imagesProtectedOnLoad) {
                    _imagesProtectedOnLoad = false; // consume el token de "ya se ejecutó"
                    return;
                }
                protectAllImages();
            });

        })();
    </script>

    <script>
        const GISCUS_ORIGIN = 'https://giscus-personal-woft.vercel.app';
        const MAX_RETRIES   = 3;
        const RETRY_DELAYS  = [1500, 3000, 6000];

        let giscusLoaded:   boolean                 = false;
        let retryCount:     number                  = 0;
        let loadGeneration: number                  = 0;
        let themeObserver:  MutationObserver | null = null;

        function currentTheme(): string {
            return document.documentElement.classList.contains('dark')
                ? 'transparent_dark'
                : 'light';
        }

        function getContainer(): HTMLElement | null {
            return document.getElementById('giscus-container');
        }

        function setupThemeObserver(): void {
            themeObserver?.disconnect();
            themeObserver = new MutationObserver(() => {
                const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
                if (!iframe?.contentWindow) return;
                iframe.contentWindow.postMessage(
                    { giscus: { setConfig: { theme: currentTheme() } } },
                    GISCUS_ORIGIN
                );
            });
            themeObserver.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['class'],
            });
        }

        function showErrorUI(container: HTMLElement): void {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8 gap-3 text-red-500">
                    <span class="text-sm">Error al cargar los comentarios</span>
                    <button id="giscus-retry-btn" class="text-xs underline hover:no-underline">
                        Reintentar
                    </button>
                </div>`;
            document.getElementById('giscus-retry-btn')?.addEventListener('click', () => {
                retryCount   = 0;
                giscusLoaded = false;
                mountGiscus();
            });
        }

        function mountGiscus(): void {
            if (giscusLoaded) return;

            const container = getContainer();
            if (!container) return;

            if (container.querySelector('script[src*="giscus"]')) return;

            const gen = loadGeneration;

            container.innerHTML = '';

            const script = document.createElement('script');
            script.src = `${GISCUS_ORIGIN}/es/client.js?v=${Date.now()}`;
            script.setAttribute('data-repo',              'Cosmos20016/Gestion-de-comentarios');
            script.setAttribute('data-repo-id',           'R_kgDOPSHLmA');
            script.setAttribute('data-category',          'Announcements');
            script.setAttribute('data-category-id',       'DIC_kwDOPSHLmM4CtXsZ');
            script.setAttribute('data-mapping',           'pathname');
            script.setAttribute('data-strict',            '0');
            script.setAttribute('data-reactions-enabled', '1');
            script.setAttribute('data-emit-metadata',     '0');
            script.setAttribute('data-input-position',    'bottom');
            script.setAttribute('data-theme',             currentTheme());
            script.setAttribute('data-lang',              'es');
            script.crossOrigin = 'anonymous';
            script.async       = true;

            script.onerror = () => {
                if (gen !== loadGeneration) return;
                if (retryCount < MAX_RETRIES) {
                    const delay = RETRY_DELAYS[retryCount++];
                    window.setTimeout(mountGiscus, delay);
                } else {
                    retryCount = 0;
                    const c = getContainer();
                    if (c) showErrorUI(c);
                }
            };

            script.onload = () => {
                if (gen !== loadGeneration) return;
                retryCount   = 0;
                giscusLoaded = true;
                setupThemeObserver();
            };

            container.appendChild(script);
        }

        function cleanup(): void {
            loadGeneration++;
            giscusLoaded = false;
            retryCount   = 0;
            themeObserver?.disconnect();
            themeObserver = null;
            const container = getContainer();
            if (container) container.innerHTML = '';
        }

        document.addEventListener('astro:before-swap', cleanup);

        document.addEventListener('astro:page-load', () => {
            if (getContainer()) mountGiscus();
        });

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                if (getContainer()) mountGiscus();
            });
        } else {
            if (getContainer()) mountGiscus();
        }
    </script>

    <style>
        /* ── Contenedor ─────────────────────────────────────────────────────── */
        #giscus-container {
            width: 100%;
            max-width: 100%;
            background: transparent !important;
            contain: layout;
            overflow: visible;
            min-height: 200px;
        }

        /* ── iframe ─────────────────────────────────────────────────────────── */
        #giscus-container :global(iframe.giscus-frame) {
            width: 100% !important;
            max-width: 100% !important;
            min-height: 250px;
            border: none !important;
            background: transparent !important;
            display: block;
            pointer-events: auto !important;
            touch-action: pan-y pan-x !important;
            -webkit-overflow-scrolling: touch;
        }

        /* ── Modo claro ─────────────────────────────────────────────────────── */
        :global(:not(.dark)) #giscus-container {
            background-color: var(--card-bg, white) !important;
        }

        :global(:not(.dark)) #giscus-container :global(iframe.giscus-frame) {
            color-scheme: light;
        }

        /* ── Modo oscuro ─────────────────────────────────────────────────────── */
        :global(.dark) #giscus-container {
            background-color: var(--card-bg, transparent) !important;
        }

        :global(.dark) #giscus-container :global(iframe.giscus-frame) {
            color-scheme: dark;
        }

        /* ── Móvil ──────────────────────────────────────────────────────────── */
        @media (max-width: 767px) {
            #giscus-container {
                padding: 1rem;
                border-radius: var(--radius-large);
            }

            #giscus-container :global(iframe.giscus-frame) {
                min-height: 300px;
            }
        }
    </style>
</MainGridLayout>
