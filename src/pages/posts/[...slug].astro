---
import path from "node:path";
import License from "@components/misc/License.astro";
import Markdown from "@components/misc/Markdown.astro";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getSortedPosts } from "@utils/content-utils";
import { getDir, getPostUrlBySlug } from "@utils/url-utils";
import { Icon } from "astro-icon/components";
import { licenseConfig } from "src/config";
import ImageWrapper from "../../components/misc/ImageWrapper.astro";
import PostMetadata from "../../components/PostMeta.astro";
import { profileConfig, siteConfig } from "../../config";
import { formatDateToYYYYMMDD } from "../../utils/date-utils";

export async function getStaticPaths() {
    const blogEntries = await getSortedPosts();
    return blogEntries.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

const { entry } = Astro.props;

const renderResult = await entry.render();
const { Content, headings } = renderResult;
const { remarkPluginFrontmatter } = renderResult;

const jsonLd = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: entry.data.title,
    description: entry.data.description || entry.data.title,
    keywords: entry.data.tags,
    url: new URL(`/posts/${entry.slug}/`, Astro.site).href,
    image: entry.data.image
        ? new URL(
                entry.data.image.startsWith("/")
                    ? entry.data.image
                    : `/${entry.data.image}`,
                Astro.site,
            ).href
        : new URL("/og-default.png", Astro.site).href,
    author: {
        "@type": "Person",
        name: profileConfig.name,
        url: Astro.site?.toString(),
    },
    publisher: {
        "@type": "Person",
        name: profileConfig.name,
        url: Astro.site?.toString(),
    },
    datePublished: formatDateToYYYYMMDD(entry.data.published),
    dateModified: entry.data.updated
        ? formatDateToYYYYMMDD(entry.data.updated)
        : formatDateToYYYYMMDD(entry.data.published),
    articleSection: entry.data.category ?? null,
    mainEntityOfPage: {
        "@type": "WebPage",
        "@id": new URL(`/posts/${entry.slug}/`, Astro.site).href,
    },
    inLanguage: entry.data.lang
        ? entry.data.lang.replace("_", "-")
        : siteConfig.lang.replace("_", "-"),
};

const nextUrl = entry.data.nextSlug ? getPostUrlBySlug(entry.data.nextSlug) : null;
const prevUrl = entry.data.prevSlug ? getPostUrlBySlug(entry.data.prevSlug) : null;
---

<MainGridLayout
    banner={entry.data.image}
    title={entry.data.title}
    description={entry.data.description}
    lang={entry.data.lang}
    setOGTypeArticle={true}
    headings={headings}
>
    <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>

    <!-- Barra de progreso de lectura: posición fixed, no ocupa espacio en el layout -->
    <div id="reading-progress" aria-hidden="true" role="presentation"></div>

    <article
        class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4"
        itemscope
        itemtype="https://schema.org/BlogPosting"
    >
        <div id="post-container" class="card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full">

            <!-- FIX: Eliminado role="complementary" — era semánticamente incorrecto.
                 complementary = landmark de sidebar independiente, no metadatos inline. -->
            <div
                class="flex flex-row text-black/30 dark:text-white/30 gap-5 mb-3 transition onload-animation"
                aria-label="Información del artículo"
            >
                <div class="flex flex-row items-center">
                    <div
                        class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
                        aria-hidden="true"
                    >
                        <Icon name="material-symbols:notes-rounded" />
                    </div>
                    <div class="text-sm">
                        <span itemprop="wordCount">{remarkPluginFrontmatter.words}</span>
                        {" " + i18n(I18nKey.wordsCount)}
                    </div>
                </div>
                <div class="flex flex-row items-center">
                    <div
                        class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
                        aria-hidden="true"
                    >
                        <Icon name="material-symbols:schedule-outline-rounded" />
                    </div>
                    <div class="text-sm">
                        <span
                            itemprop="timeRequired"
                            content={`PT${remarkPluginFrontmatter.minutes}M`}
                        >
                            {remarkPluginFrontmatter.minutes}
                        </span>
                        {" " + i18n(remarkPluginFrontmatter.minutes === 1 ? I18nKey.minuteCount : I18nKey.minutesCount)}
                    </div>
                </div>
            </div>

            <header class="relative onload-animation">
                <h1
                    data-pagefind-body
                    data-pagefind-weight="10"
                    data-pagefind-meta="title"
                    itemprop="headline"
                    class="transition w-full block font-bold mb-3
                    text-3xl md:text-[2.25rem]/[2.75rem]
                    text-black/90 dark:text-white/90
                    md:before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)]
                    before:absolute before:top-[0.75rem] before:left-[-1.125rem]"
                >
                    {entry.data.title}
                </h1>
            </header>

            <div class="onload-animation">
                <PostMetadata
                    class="mb-5"
                    published={entry.data.published}
                    updated={entry.data.updated}
                    tags={entry.data.tags}
                    category={entry.data.category}
                />
                {!entry.data.image && (
                    <div class="border-[var(--line-divider)] border-dashed border-b-[1px] mb-5"></div>
                )}
            </div>

            {entry.data.image && (
                <ImageWrapper
                    id="post-cover"
                    src={entry.data.image}
                    basePath={path.join("content/posts/", getDir(entry.id))}
                    class="mb-8 rounded-xl banner-container onload-animation"
                    itemprop="image"
                />
            )}

            <div itemprop="articleBody">
                <Markdown class="mb-6 markdown-content onload-animation">
                    <Content />
                </Markdown>
            </div>

            {licenseConfig.enable && (
                <License
                    title={entry.data.title}
                    slug={entry.slug}
                    pubDate={entry.data.published}
                    class="mb-6 rounded-xl license-container onload-animation"
                />
            )}
        </div>
    </article>

    <nav
        class="flex flex-col md:flex-row justify-between mb-4 gap-4 overflow-hidden w-full"
        aria-label="Navegación entre artículos"
    >
        {nextUrl ? (
            <a
                href={nextUrl}
                class="w-full font-bold overflow-hidden active:scale-95 transition-transform"
                aria-label={`Anterior: ${entry.data.nextTitle}`}
                rel="prev"
            >
                <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-start gap-4">
                    <Icon
                        name="material-symbols:chevron-left-rounded"
                        class="text-[2rem] text-[var(--primary)] flex-shrink-0"
                        aria-hidden="true"
                    />
                    <span class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
                        {entry.data.nextTitle}
                    </span>
                </div>
            </a>
        ) : (
            <div class="w-full" aria-hidden="true"></div>
        )}

        {prevUrl ? (
            <a
                href={prevUrl}
                class="w-full font-bold overflow-hidden active:scale-95 transition-transform"
                aria-label={`Siguiente: ${entry.data.prevTitle}`}
                rel="next"
            >
                <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-end gap-4">
                    <span class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
                        {entry.data.prevTitle}
                    </span>
                    <Icon
                        name="material-symbols:chevron-right-rounded"
                        class="text-[2rem] text-[var(--primary)] flex-shrink-0"
                        aria-hidden="true"
                    />
                </div>
            </a>
        ) : (
            <div class="w-full" aria-hidden="true"></div>
        )}
    </nav>

    <!-- FIX: Padding unificado solo en Tailwind. Eliminado el @media que duplicaba padding en mobile. -->
    <section
        id="giscus-container"
        transition:name="giscus"
        transition:animate="none"
        class="card-base rounded-[var(--radius-large)] px-6 md:px-9 py-6"
        aria-label="Comentarios del artículo"
    ></section>

    <!-- ─────────────────────────────────────────────────────────────────────
         Protecciones de contenido + UX de lectura
    ───────────────────────────────────────────────────────────────────────── -->
    <script is:inline>
        (function () {
            'use strict';

            /* ── Atribución automática al copiar ── */
            var SITE_URL    = 'Kevinborja.com';
            var ATTRIBUTION = '\n\n— Extraído de ' + SITE_URL;
            var MIN_CHARS   = 80;

            function escapeHtml(str) {
                return str
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/\n/g, '<br>');
            }

            document.addEventListener('copy', function (e) {
                if (!e.clipboardData) return;
                var selection = window.getSelection();
                if (!selection || selection.isCollapsed) return;
                var selectedText = selection.toString();
                if (selectedText.trim().length < MIN_CHARS) return;

                var htmlAttribution =
                    '<br><br><em>— Extraído de <a href="https://' +
                    SITE_URL + '">' + SITE_URL + '</a></em>';
                try {
                    e.clipboardData.setData('text/plain', selectedText + ATTRIBUTION);
                    e.clipboardData.setData(
                        'text/html',
                        '<span>' + escapeHtml(selectedText) + '</span>' + htmlAttribution
                    );
                    e.preventDefault();
                } catch (_) {}
            });

            /* ── Protección de imágenes del artículo ── */
            function lockImages() {
                var articleBody = document.querySelector('[itemprop="articleBody"]');
                if (!articleBody) return;
                articleBody.querySelectorAll('img').forEach(function (img) {
                    if (img.dataset.imgLocked) return;
                    img.dataset.imgLocked = '1';
                    img.addEventListener('dragstart',   function (e) { e.preventDefault(); });
                    img.addEventListener('contextmenu', function (e) { e.preventDefault(); });
                });
            }

            /* ── Protección SVG via Canvas ──
               Uso: añade data-protect al SVG que quieres proteger.
               <svg data-protect viewBox="0 0 200 80">...</svg>
               Se preserva el aria-label / <title> del SVG para accesibilidad.
            ── */
            function protectSVGs() {
                document.querySelectorAll('svg[data-protect]').forEach(function (svg) {
                    if (svg.dataset.svgProtected) return;
                    svg.dataset.svgProtected = '1';

                    var vb   = svg.viewBox && svg.viewBox.baseVal;
                    var rect = svg.getBoundingClientRect();
                    var w    = (vb && vb.width  > 0 ? vb.width  : null) || rect.width  || 300;
                    var h    = (vb && vb.height > 0 ? vb.height : null) || rect.height || 150;
                    var dpr  = window.devicePixelRatio || 1;

                    var svgTitle    = svg.querySelector('title');
                    var accessLabel = svg.getAttribute('aria-label')
                        || (svgTitle ? svgTitle.textContent.trim() : null);

                    var canvas         = document.createElement('canvas');
                    canvas.width       = Math.round(w * dpr);
                    canvas.height      = Math.round(h * dpr);
                    canvas.style.width = w + 'px';
                    canvas.style.height = h + 'px';
                    canvas.className   = svg.getAttribute('class') || '';

                    if (accessLabel) {
                        canvas.setAttribute('role', 'img');
                        canvas.setAttribute('aria-label', accessLabel);
                    } else {
                        canvas.setAttribute('aria-hidden', 'true');
                    }

                    var ctx  = canvas.getContext('2d');
                    var blob = new Blob(
                        [new XMLSerializer().serializeToString(svg)],
                        { type: 'image/svg+xml;charset=utf-8' }
                    );
                    var url = URL.createObjectURL(blob);
                    var img = new Image();

                    img.onload = function () {
                        ctx.scale(dpr, dpr);
                        ctx.drawImage(img, 0, 0, w, h);
                        URL.revokeObjectURL(url);
                        if (svg.parentNode) svg.parentNode.replaceChild(canvas, svg);
                    };
                    img.onerror = function () { URL.revokeObjectURL(url); };
                    img.src = url;
                });
            }

            /* ── Indicador de progreso de lectura ──
               Cálculo: 0 % al llegar al inicio del artículo, 100 % al llegar al final.
               Usa requestAnimationFrame + transform:scaleX → solo composite layer,
               cero repaints, sin jank ni layout thrashing.
            ── */
            function initReadingProgress() {
                var bar     = document.getElementById('reading-progress');
                var article = document.querySelector('[itemprop="articleBody"]');
                if (!bar || !article) return;

                var rafId = 0;

                function update() {
                    rafId = 0;
                    var articleTop    = article.getBoundingClientRect().top + window.scrollY;
                    var articleHeight = article.offsetHeight;
                    var scrolled      = window.scrollY - articleTop;
                    var range         = articleHeight - window.innerHeight;
                    var progress      = range > 0
                        ? Math.max(0, Math.min(1, scrolled / range))
                        : (scrolled > 0 ? 1 : 0);
                    bar.style.transform = 'scaleX(' + progress + ')';
                }

                function onScroll() {
                    if (!rafId) rafId = requestAnimationFrame(update);
                }

                window.addEventListener('scroll', onScroll, { passive: true });
                update();

                document.addEventListener('astro:before-swap', function cleanup() {
                    window.removeEventListener('scroll', onScroll);
                    document.removeEventListener('astro:before-swap', cleanup);
                }, { once: true });
            }

            /* ── Botón "Copiar" en bloques de código ── */
            function initCodeCopyButtons() {
                var articleBody = document.querySelector('[itemprop="articleBody"]');
                if (!articleBody) return;

                articleBody.querySelectorAll('pre').forEach(function (pre) {
                    if (pre.dataset.copyInit) return;
                    pre.dataset.copyInit = '1';

                    var wrapper     = document.createElement('div');
                    wrapper.className = 'code-block-wrapper';

                    var btn         = document.createElement('button');
                    btn.className   = 'code-copy-btn';
                    btn.textContent = 'Copiar';
                    btn.setAttribute('aria-label', 'Copiar código');
                    btn.setAttribute('type', 'button');

                    btn.addEventListener('click', function () {
                        var code = pre.querySelector('code');
                        var text = code ? code.innerText : pre.innerText;
                        navigator.clipboard.writeText(text).then(function () {
                            btn.textContent = '¡Copiado!';
                            btn.classList.add('copied');
                            setTimeout(function () {
                                btn.textContent = 'Copiar';
                                btn.classList.remove('copied');
                            }, 2000);
                        }).catch(function () {});
                    });

                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(pre);
                    wrapper.appendChild(btn);
                });
            }

            /* ── Punto de entrada único ── */
            function initAll() {
                lockImages();
                protectSVGs();
                initReadingProgress();
                initCodeCopyButtons();
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initAll);
            } else {
                initAll();
            }

            document.addEventListener('astro:page-load', initAll);

        })();
    </script>

    <!-- ─── Giscus ─── -->
    <script>
        const GISCUS_ORIGIN = 'https://giscus-personal-woft.vercel.app';
        const MAX_RETRIES   = 3;
        const RETRY_DELAYS  = [1500, 3000, 6000];

        let giscusLoaded:   boolean                 = false;
        let retryCount:     number                  = 0;
        let loadGeneration: number                  = 0;
        let themeObserver:  MutationObserver | null = null;

        function currentTheme(): string {
            return document.documentElement.classList.contains('dark')
                ? 'transparent_dark'
                : 'light';
        }

        function getContainer(): HTMLElement | null {
            return document.getElementById('giscus-container');
        }

        function setupThemeObserver(): void {
            themeObserver?.disconnect();
            themeObserver = new MutationObserver(() => {
                const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
                if (!iframe?.contentWindow) return;
                iframe.contentWindow.postMessage(
                    { giscus: { setConfig: { theme: currentTheme() } } },
                    GISCUS_ORIGIN
                );
            });
            themeObserver.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['class'],
            });
        }

        function showErrorUI(container: HTMLElement): void {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8 gap-3 text-red-500">
                    <span class="text-sm">Error al cargar los comentarios</span>
                    <button id="giscus-retry-btn" class="text-xs underline hover:no-underline">
                        Reintentar
                    </button>
                </div>`;
            document.getElementById('giscus-retry-btn')?.addEventListener('click', () => {
                retryCount   = 0;
                giscusLoaded = false;
                mountGiscus();
            });
        }

        function mountGiscus(): void {
            if (giscusLoaded) return;
            const container = getContainer();
            if (!container) return;
            if (container.querySelector('script[src*="giscus"]')) return;

            const gen = loadGeneration;
            container.innerHTML = '';

            const script = document.createElement('script');
            // FIX: Date.now() como cache buster impedía que el CDN cacheara el script,
            // forzando una descarga nueva en cada visita. cleanup() ya vacía el
            // container en cada navegación SPA — no se necesita cache busting.
            script.src = `${GISCUS_ORIGIN}/es/client.js`;
            script.setAttribute('data-repo',              'Cosmos20016/Gestion-de-comentarios');
            script.setAttribute('data-repo-id',           'R_kgDOPSHLmA');
            script.setAttribute('data-category',          'Announcements');
            script.setAttribute('data-category-id',       'DIC_kwDOPSHLmM4CtXsZ');
            script.setAttribute('data-mapping',           'pathname');
            script.setAttribute('data-strict',            '0');
            script.setAttribute('data-reactions-enabled', '1');
            script.setAttribute('data-emit-metadata',     '0');
            script.setAttribute('data-input-position',    'bottom');
            script.setAttribute('data-theme',             currentTheme());
            script.setAttribute('data-lang',              'es');
            script.crossOrigin = 'anonymous';
            script.async       = true;

            script.onerror = () => {
                if (gen !== loadGeneration) return;
                if (retryCount < MAX_RETRIES) {
                    window.setTimeout(mountGiscus, RETRY_DELAYS[retryCount++]);
                } else {
                    retryCount = 0;
                    const c = getContainer();
                    if (c) showErrorUI(c);
                }
            };

            script.onload = () => {
                if (gen !== loadGeneration) return;
                retryCount   = 0;
                giscusLoaded = true;
                setupThemeObserver();
            };

            container.appendChild(script);
        }

        function cleanup(): void {
            loadGeneration++;
            giscusLoaded = false;
            retryCount   = 0;
            themeObserver?.disconnect();
            themeObserver = null;
            const container = getContainer();
            if (container) container.innerHTML = '';
        }

        document.addEventListener('astro:before-swap', cleanup);
        document.addEventListener('astro:page-load', () => {
            if (getContainer()) mountGiscus();
        });

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                if (getContainer()) mountGiscus();
            });
        } else {
            if (getContainer()) mountGiscus();
        }
    </script>

    <style>
        /* ── Barra de progreso de lectura ── */
        #reading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
            transform: scaleX(0);
            transform-origin: left center;
            z-index: 9999;
            pointer-events: none;
            will-change: transform;
        }

        @media (prefers-reduced-motion: reduce) {
            #reading-progress {
                transition: none;
            }
        }

        /* ── Botones de copia en bloques de código ── */
        .code-block-wrapper {
            position: relative;
        }

        .code-copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.2rem 0.6rem;
            font-size: 0.7rem;
            line-height: 1.4;
            border-radius: 0.35rem;
            border: 1px solid color-mix(in srgb, var(--primary) 40%, transparent);
            background: color-mix(in srgb, var(--primary) 10%, transparent);
            color: var(--primary);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s ease, background 0.15s ease;
            font-family: inherit;
        }

        .code-block-wrapper:hover .code-copy-btn,
        .code-copy-btn:focus-visible {
            opacity: 1;
        }

        .code-copy-btn.copied {
            background: color-mix(in srgb, var(--primary) 25%, transparent);
            opacity: 1;
        }

        .code-copy-btn:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            .code-copy-btn {
                transition: none;
            }
        }

        /* ── Giscus ── */
        #giscus-container {
            width: 100%;
            max-width: 100%;
            background: transparent !important;
            contain: layout;
            overflow: visible;
            min-height: 200px;
        }

        #giscus-container :global(iframe.giscus-frame) {
            width: 100% !important;
            max-width: 100% !important;
            min-height: 250px;
            border: none !important;
            background: transparent !important;
            display: block;
            pointer-events: auto !important;
            touch-action: pan-y pan-x !important;
            -webkit-overflow-scrolling: touch;
        }

        :global(:not(.dark)) #giscus-container {
            background-color: var(--card-bg, white) !important;
        }

        :global(:not(.dark)) #giscus-container :global(iframe.giscus-frame) {
            color-scheme: light;
        }

        :global(.dark) #giscus-container {
            background-color: var(--card-bg, transparent) !important;
        }

        :global(.dark) #giscus-container :global(iframe.giscus-frame) {
            color-scheme: dark;
        }

        @media (max-width: 767px) {
            #giscus-container :global(iframe.giscus-frame) {
                min-height: 300px;
            }
        }
    </style>
</MainGridLayout>
