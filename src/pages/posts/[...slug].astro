---
import path from "node:path";
import License from "@components/misc/License.astro";
import Markdown from "@components/misc/Markdown.astro";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getSortedPosts } from "@utils/content-utils";
import { getDir, getPostUrlBySlug } from "@utils/url-utils";
import { Icon } from "astro-icon/components";
import { licenseConfig } from "src/config";
import ImageWrapper from "../../components/misc/ImageWrapper.astro";
import PostMetadata from "../../components/PostMeta.astro";
import { profileConfig, siteConfig } from "../../config";
import { formatDateToYYYYMMDD } from "../../utils/date-utils";

export async function getStaticPaths() {
    const blogEntries = await getSortedPosts();
    return blogEntries.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

const { entry } = Astro.props;

// Render una sola vez para m√°xima eficiencia
const renderResult = await entry.render();
const { Content, headings } = renderResult;
const { remarkPluginFrontmatter } = renderResult;

// JSON-LD optimizado para SEO
const jsonLd = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: entry.data.title,
    description: entry.data.description || entry.data.title,
    keywords: entry.data.tags,
    image: entry.data.image
        ? new URL(
                entry.data.image.startsWith("/")
                    ? entry.data.image
                    : `/${entry.data.image}`,
                Astro.site,
            ).href
        : new URL("/og-default.png", Astro.site).href,
    author: {
        "@type": "Person",
        name: profileConfig.name,
        url: Astro.site?.toString(),
    },
    publisher: {
        "@type": "Person",
        name: profileConfig.name,
        url: Astro.site?.toString(),
    },
    datePublished: formatDateToYYYYMMDD(entry.data.published),
    dateModified: entry.data.updated
        ? formatDateToYYYYMMDD(entry.data.updated)
        : formatDateToYYYYMMDD(entry.data.published),
    mainEntityOfPage: {
        "@type": "WebPage",
        "@id": new URL(`/posts/${entry.slug}/`, Astro.site).href,
    },
    inLanguage: entry.data.lang
        ? entry.data.lang.replace("_", "-")
        : siteConfig.lang.replace("_", "-"),
};

// Calcular URLs de navegaci√≥n una sola vez
const nextUrl = entry.data.nextSlug ? getPostUrlBySlug(entry.data.nextSlug) : null;
const prevUrl = entry.data.prevSlug ? getPostUrlBySlug(entry.data.prevSlug) : null;
---
<MainGridLayout 
    banner={entry.data.image} 
    title={entry.data.title} 
    description={entry.data.description} 
    lang={entry.data.lang} 
    setOGTypeArticle={true} 
    headings={headings}
>
    <!-- JSON-LD para SEO -->
    <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>
    
    <!-- Art√≠culo principal -->
    <article 
        class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4"
        itemscope 
        itemtype="https://schema.org/BlogPosting"
    >
        <div 
            id="post-container" 
            class:list={["card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full", {}]}
        >
            <!-- Metadatos del post (word count y tiempo de lectura) -->
            <div 
                class="flex flex-row text-black/30 dark:text-white/30 gap-5 mb-3 transition onload-animation"
                role="complementary"
                aria-label="Informaci√≥n del art√≠culo"
            >
                <div class="flex flex-row items-center">
                    <div 
                        class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
                        aria-hidden="true"
                    >
                        <Icon name="material-symbols:notes-rounded"></Icon>
                    </div>
                    <div class="text-sm">
                        <span itemprop="wordCount">{remarkPluginFrontmatter.words}</span>
                        {" " + i18n(I18nKey.wordsCount)}
                    </div>
                </div>
                <div class="flex flex-row items-center">
                    <div 
                        class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
                        aria-hidden="true"
                    >
                        <Icon name="material-symbols:schedule-outline-rounded"></Icon>
                    </div>
                    <div class="text-sm">
                        <span itemprop="timeRequired" content={`PT${remarkPluginFrontmatter.minutes}M`}>
                            {remarkPluginFrontmatter.minutes}
                        </span>
                        {" " + i18n(remarkPluginFrontmatter.minutes === 1 ? I18nKey.minuteCount : I18nKey.minutesCount)}
                    </div>
                </div>
            </div>

            <!-- T√≠tulo del post -->
            <header class="relative onload-animation">
                <h1
                    data-pagefind-body 
                    data-pagefind-weight="10" 
                    data-pagefind-meta="title"
                    itemprop="headline"
                    class="transition w-full block font-bold mb-3
                    text-3xl md:text-[2.25rem]/[2.75rem]
                    text-black/90 dark:text-white/90
                    md:before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)]
                    before:absolute before:top-[0.75rem] before:left-[-1.125rem]
                ">
                    {entry.data.title}
                </h1>
            </header>

            <!-- Metadata (fecha, tags, categor√≠a) -->
            <div class="onload-animation">
                <PostMetadata
                    class="mb-5"
                    published={entry.data.published}
                    updated={entry.data.updated}
                    tags={entry.data.tags}
                    category={entry.data.category}
                ></PostMetadata>
                {!entry.data.image && (
                    <div class="border-[var(--line-divider)] border-dashed border-b-[1px] mb-5"></div>
                )}
            </div>

            <!-- Imagen de portada -->
            {entry.data.image && (
                <ImageWrapper 
                    id="post-cover" 
                    src={entry.data.image} 
                    basePath={path.join("content/posts/", getDir(entry.id))} 
                    class="mb-8 rounded-xl banner-container onload-animation"
                    itemprop="image"
                />
            )}

            <!-- Contenido del art√≠culo -->
            <div itemprop="articleBody">
                <Markdown class="mb-6 markdown-content onload-animation">
                    <Content />
                </Markdown>
            </div>

            <!-- Licencia -->
            {licenseConfig.enable && (
                <License 
                    title={entry.data.title} 
                    slug={entry.slug} 
                    pubDate={entry.data.published} 
                    class="mb-6 rounded-xl license-container onload-animation"
                ></License>
            )}
        </div>
    </article>

    <!-- Navegaci√≥n entre posts -->
    <nav 
        class="flex flex-col md:flex-row justify-between mb-4 gap-4 overflow-hidden w-full"
        aria-label="Navegaci√≥n entre art√≠culos"
    >
        <!-- Post anterior -->
        {nextUrl ? (
            <a 
                href={nextUrl}
                class="w-full font-bold overflow-hidden active:scale-95 transition-transform"
                aria-label={`Anterior: ${entry.data.nextTitle}`}
                rel="prev"
            >
                <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-start gap-4">
                    <Icon 
                        name="material-symbols:chevron-left-rounded" 
                        class="text-[2rem] text-[var(--primary)] flex-shrink-0" 
                        aria-hidden="true"
                    />
                    <span class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
                        {entry.data.nextTitle}
                    </span>
                </div>
            </a>
        ) : (
            <div class="w-full" aria-hidden="true"></div>
        )}

        <!-- Post siguiente -->
        {prevUrl ? (
            <a 
                href={prevUrl}
                class="w-full font-bold overflow-hidden active:scale-95 transition-transform"
                aria-label={`Siguiente: ${entry.data.prevTitle}`}
                rel="next"
            >
                <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-end gap-4">
                    <span class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
                        {entry.data.prevTitle}
                    </span>
                    <Icon 
                        name="material-symbols:chevron-right-rounded" 
                        class="text-[2rem] text-[var(--primary)] flex-shrink-0" 
                        aria-hidden="true"
                    />
                </div>
            </a>
        ) : (
            <div class="w-full" aria-hidden="true"></div>
        )}
    </nav>

    <!-- Secci√≥n de comentarios con Giscus -->
    <section 
        id="giscus-container" 
        class="card-base rounded-[var(--radius-large)] px-6 md:px-9 py-6 mt-6"
        aria-label="Comentarios del art√≠culo"
    >
        <div class="flex flex-col items-center justify-center py-8 gap-3 text-black/50 dark:text-white/50">
            <span class="text-sm" role="status" aria-live="polite">Cargando comentarios...</span>
            <button 
                id="giscus-manual-load" 
                class="hidden text-xs px-4 py-2 rounded-lg bg-[var(--primary)] text-white hover:opacity-80 transition-opacity"
                aria-label="Cargar comentarios manualmente"
            >
                Cargar comentarios
            </button>
        </div>
    </section>

    <script>
        // ============================================
        // GISCUS COMMENTS - ULTRA OPTIMIZADO M√ìVIL
        // 100% funcional mobile-first con fallbacks
        // ============================================

        interface GiscusMessage {
            giscus: {
                setConfig: {
                    theme: string;
                };
            };
        }

        // Estado global
        let giscusLoaded = false;
        let themeObserver: MutationObserver | null = null;
        let intersectionObserver: IntersectionObserver | null = null;
        let loadAttempts = 0;
        let fallbackTimer: number | null = null;
        const MAX_LOAD_ATTEMPTS = 3;
        const FALLBACK_TIMEOUT = 3000; // 3 segundos de fallback en m√≥vil
        
        /**
         * Detecta si estamos en dispositivo m√≥vil
         */
        function isMobileDevice(): boolean {
            const ua = navigator.userAgent.toLowerCase();
            const isMobileUA = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
            const isSmallScreen = window.innerWidth < 768;
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            return isMobileUA || (isSmallScreen && isTouchDevice);
        }
        
        /**
         * Obtiene el tema actual del documento
         */
        function getCurrentTheme(): string {
            return document.documentElement.classList.contains('dark') 
                ? 'transparent_dark' 
                : 'light';
        }
        
        /**
         * Actualiza el estado de carga en el contenedor
         */
        function updateLoadingState(message: string, isError = false, showButton = false): void {
            const container = document.getElementById('giscus-container');
            if (!container) return;
            
            const colorClass = isError 
                ? 'text-red-500 dark:text-red-400' 
                : 'text-black/50 dark:text-white/50';
            
            const buttonHtml = showButton 
                ? `<button 
                    id="giscus-manual-load" 
                    class="text-xs px-4 py-2 rounded-lg bg-[var(--primary)] text-white hover:opacity-80 transition-opacity active:scale-95"
                    aria-label="Cargar comentarios manualmente"
                    onclick="window.__loadGiscusManually()"
                >
                    Cargar comentarios
                </button>` 
                : '';
            
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8 gap-3 ${colorClass}">
                    <span class="text-sm text-center px-4" role="status" aria-live="polite">${message}</span>
                    ${buttonHtml}
                    ${isError ? '<button onclick="location.reload()" class="text-xs underline hover:no-underline mt-2">Recargar p√°gina</button>' : ''}
                </div>
            `;
        }
        
        /**
         * Espera a que el iframe de Giscus est√© completamente cargado
         */
        function waitForGiscusIframe(maxAttempts = 30): Promise<HTMLIFrameElement | null> {
            return new Promise((resolve) => {
                let attempts = 0;
                
                const checkIframe = () => {
                    const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
                    
                    if (iframe && iframe.contentWindow) {
                        console.log('[Giscus] ‚úì Iframe loaded successfully');
                        resolve(iframe);
                        return;
                    }
                    
                    attempts++;
                    if (attempts >= maxAttempts) {
                        console.warn('[Giscus] ‚ö† Iframe timeout after', maxAttempts, 'attempts');
                        resolve(null);
                        return;
                    }
                    
                    setTimeout(checkIframe, 200);
                };
                
                checkIframe();
            });
        }
        
        /**
         * Carga el script de Giscus de forma optimizada
         */
        async function loadGiscus(): Promise<void> {
            if (giscusLoaded) {
                console.log('[Giscus] Already loaded, skipping');
                return;
            }
            
            const container = document.getElementById('giscus-container');
            if (!container) {
                console.warn('[Giscus] Container not found');
                return;
            }
            
            // Cancelar timer de fallback si existe
            if (fallbackTimer) {
                clearTimeout(fallbackTimer);
                fallbackTimer = null;
            }
            
            loadAttempts++;
            const isMobile = isMobileDevice();
            console.log(`[Giscus] üöÄ Loading (attempt ${loadAttempts}/${MAX_LOAD_ATTEMPTS}) on ${isMobile ? 'MOBILE' : 'DESKTOP'}`);
            
            // Limpiar contenido previo
            container.innerHTML = '';
            
            const currentTheme = getCurrentTheme();
            
            // Crear script de Giscus
            const script = document.createElement('script');
            script.src = 'https://giscus-personal-woft.vercel.app/es/client.js';
            script.setAttribute('data-repo', 'Cosmos20016/Gestion-de-comentarios');
            script.setAttribute('data-repo-id', 'R_kgDOPSHLmA');
            script.setAttribute('data-category', 'Announcements');
            script.setAttribute('data-category-id', 'DIC_kwDOPSHLmM4CtXsZ');
            script.setAttribute('data-mapping', 'pathname');
            script.setAttribute('data-strict', '0');
            script.setAttribute('data-reactions-enabled', '1');
            script.setAttribute('data-emit-metadata', '0');
            script.setAttribute('data-input-position', 'bottom');
            script.setAttribute('data-theme', currentTheme);
            script.setAttribute('data-lang', 'es');
            script.setAttribute('data-loading', 'lazy');
            script.crossOrigin = 'anonymous';
            script.async = true;
            
            // Manejo de errores
            script.onerror = () => {
                console.error('[Giscus] ‚ùå Script load failed');
                
                if (loadAttempts < MAX_LOAD_ATTEMPTS) {
                    updateLoadingState('Reintentando cargar comentarios...');
                    setTimeout(() => loadGiscus(), 2000);
                } else {
                    updateLoadingState(
                        'No se pudieron cargar los comentarios.',
                        true,
                        true
                    );
                }
            };
            
            // Callback de √©xito
            script.onload = async () => {
                console.log('[Giscus] ‚úì Script loaded');
                giscusLoaded = true;
                
                // Esperar a que el iframe est√© listo
                const iframe = await waitForGiscusIframe();
                
                if (iframe) {
                    // Configurar observador de tema
                    setupThemeObserver();
                    
                    // Aplicar estilos personalizados
                    setTimeout(() => applyGiscusStyles(), 300);
                    
                    console.log('[Giscus] ‚úì Fully initialized');
                } else {
                    console.warn('[Giscus] ‚ö† Iframe not available, basic functionality only');
                }
            };
            
            container.appendChild(script);
        }
        
        /**
         * Aplica estilos personalizados al iframe de Giscus
         */
        function applyGiscusStyles(): void {
            const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
            if (!iframe) return;
            
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                if (iframeDoc) {
                    const style = iframeDoc.createElement('style');
                    style.textContent = `
                        body { 
                            background: transparent !important;
                            font-size: 14px !important;
                        }
                        .giscus { 
                            background: transparent !important; 
                        }
                        @media (max-width: 768px) {
                            body {
                                font-size: 13px !important;
                            }
                            button, a {
                                min-height: 44px !important;
                                min-width: 44px !important;
                            }
                        }
                    `;
                    iframeDoc.head.appendChild(style);
                    console.log('[Giscus] ‚úì Custom styles applied');
                }
            } catch (e) {
                // CORS restriction - normal en producci√≥n
                console.log('[Giscus] Using external styles (CORS)');
            }
        }
        
        /**
         * Configura el observador de cambios de tema
         */
        function setupThemeObserver(): void {
            if (themeObserver) {
                themeObserver.disconnect();
            }
            
            themeObserver = new MutationObserver((mutations) => {
                const hasThemeChange = mutations.some(
                    m => m.type === 'attributes' && m.attributeName === 'class'
                );
                
                if (!hasThemeChange) return;
                
                const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
                if (!iframe?.contentWindow) return;
                
                const theme = getCurrentTheme();
                const message: GiscusMessage = { 
                    giscus: { setConfig: { theme } } 
                };
                
                try {
                    iframe.contentWindow.postMessage(
                        message,
                        'https://giscus-personal-woft.vercel.app'
                    );
                    console.log(`[Giscus] ‚úì Theme changed to: ${theme}`);
                    
                    // Reaplicar estilos
                    setTimeout(() => applyGiscusStyles(), 200);
                } catch (e) {
                    console.error('[Giscus] Error sending theme message:', e);
                }
            });
            
            themeObserver.observe(document.documentElement, { 
                attributes: true, 
                attributeFilter: ['class']
            });
            
            console.log('[Giscus] ‚úì Theme observer active');
        }
        
        /**
         * Verifica si el contenedor ya es visible
         */
        function isContainerVisible(): boolean {
            const container = document.getElementById('giscus-container');
            if (!container) return false;
            
            const rect = container.getBoundingClientRect();
            const windowHeight = window.innerHeight || document.documentElement.clientHeight;
            
            // Considerar visible si est√° en viewport o muy cerca
            return rect.top < windowHeight + 300;
        }
        
        /**
         * Inicializa la carga con estrategia dual: IntersectionObserver + Fallback Timer
         */
        function initGiscusLoad(): void {
            const container = document.getElementById('giscus-container');
            if (!container) {
                console.warn('[Giscus] Container not found');
                return;
            }
            
            const isMobile = isMobileDevice();
            console.log(`[Giscus] Initializing on ${isMobile ? 'MOBILE' : 'DESKTOP'} device`);
            
            // ESTRATEGIA 1: Si ya es visible, cargar inmediatamente
            if (isContainerVisible()) {
                console.log('[Giscus] Container already visible, loading immediately');
                loadGiscus();
                return;
            }
            
            // ESTRATEGIA 2: IntersectionObserver (primaria)
            if (intersectionObserver) {
                intersectionObserver.disconnect();
            }
            
            // rootMargin m√°s agresivo en m√≥vil para mejor UX
            const rootMargin = isMobile ? '150px' : '250px';
            
            intersectionObserver = new IntersectionObserver(
                (entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && !giscusLoaded) {
                            console.log('[Giscus] ‚úì Container intersecting, loading via observer');
                            
                            // Cancelar timer de fallback
                            if (fallbackTimer) {
                                clearTimeout(fallbackTimer);
                                fallbackTimer = null;
                            }
                            
                            loadGiscus();
                            intersectionObserver?.disconnect();
                        }
                    });
                }, 
                {
                    rootMargin,
                    threshold: 0.01
                }
            );
            
            intersectionObserver.observe(container);
            console.log(`[Giscus] ‚úì Observer active (rootMargin: ${rootMargin})`);
            
            // ESTRATEGIA 3: Fallback Timer (secundaria, cr√≠tica para m√≥vil)
            // Si el observer no se activa en X segundos, forzar carga
            fallbackTimer = window.setTimeout(() => {
                if (!giscusLoaded) {
                    console.log('[Giscus] ‚ö† Fallback timer triggered, forcing load');
                    updateLoadingState('Preparando comentarios...', false, true);
                    
                    // En m√≥vil, mostrar bot√≥n manual despu√©s del timeout
                    if (isMobile) {
                        const button = document.getElementById('giscus-manual-load');
                        if (button) {
                            button.classList.remove('hidden');
                        }
                    } else {
                        // En desktop, cargar autom√°ticamente
                        loadGiscus();
                    }
                }
            }, FALLBACK_TIMEOUT);
        }
        
        /**
         * Carga manual de Giscus (llamada desde bot√≥n)
         */
        function loadGiscusManually(): void {
            console.log('[Giscus] Manual load triggered');
            const button = document.getElementById('giscus-manual-load');
            if (button) {
                button.textContent = 'Cargando...';
                button.setAttribute('disabled', 'true');
            }
            loadGiscus();
        }
        
        // Exportar para uso en bot√≥n
        (window as any).__loadGiscusManually = loadGiscusManually;
        
        /**
         * Limpia todos los recursos
         */
        function cleanup(): void {
            console.log('[Giscus] Cleaning up');
            
            giscusLoaded = false;
            loadAttempts = 0;
            
            if (fallbackTimer) {
                clearTimeout(fallbackTimer);
                fallbackTimer = null;
            }
            
            if (themeObserver) {
                themeObserver.disconnect();
                themeObserver = null;
            }
            
            if (intersectionObserver) {
                intersectionObserver.disconnect();
                intersectionObserver = null;
            }
        }
        
        /**
         * Maneja cambios de p√°gina en SPA
         */
        function handlePageChange(): void {
            cleanup();
            
            // Delay para asegurar que el DOM est√© listo
            setTimeout(() => {
                initGiscusLoad();
            }, 150);
        }
        
        /**
         * Configura integraci√≥n con swup
         */
        function initSwupIntegration(): void {
            if (typeof window === 'undefined') return;
            
            if (window.swup?.hooks) {
                window.swup.hooks.on('page:view', handlePageChange);
                console.log('[Giscus] ‚úì Swup integration ready');
            } else {
                document.addEventListener('swup:enable', () => {
                    if (window.swup?.hooks) {
                        window.swup.hooks.on('page:view', handlePageChange);
                        console.log('[Giscus] ‚úì Swup integration ready (delayed)');
                    }
                }, { once: true });
            }
        }
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        
        // Asegurar que el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('[Giscus] DOM ready');
                initGiscusLoad();
                initSwupIntegration();
            });
        } else {
            console.log('[Giscus] DOM already ready');
            initGiscusLoad();
            initSwupIntegration();
        }
        
        // Cleanup en descarga de p√°gina
        window.addEventListener('beforeunload', cleanup);
        
        // Re-check en resize (√∫til en m√≥vil al rotar)
        let resizeTimer: number;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = window.setTimeout(() => {
                if (!giscusLoaded && isContainerVisible()) {
                    console.log('[Giscus] Container visible after resize');
                    loadGiscus();
                }
            }, 500);
        });
        
        console.log('[Giscus] ‚úì Module initialized');
    </script>

    <style>
        /* ============================================
           GISCUS COMMENTS STYLES
           Mobile-first con optimizaciones t√°ctiles
           ============================================ */
        
        /* --- Container Base --- */
        #giscus-container {
            width: 100%;
            max-width: 100%;
            background: transparent !important;
            contain: layout;
            overflow: hidden;
            min-height: 200px; /* Prevenir colapso en carga */
        }
        
        /* --- Iframe Responsive --- */
        #giscus-container :global(iframe.giscus-frame) {
            width: 100% !important;
            max-width: 100% !important;
            min-height: 250px;
            border: none !important;
            background: transparent !important;
            display: block;
            contain: layout style paint;
        }
        
        /* --- Light Theme --- */
        :global(:not(.dark)) #giscus-container {
            background-color: var(--card-bg, white) !important;
        }
        
        :global(:not(.dark)) #giscus-container :global(iframe.giscus-frame) {
            color-scheme: light;
        }
        
        /* --- Dark Theme --- */
        :global(.dark) #giscus-container {
            background-color: var(--card-bg, transparent) !important;
        }
        
        :global(.dark) #giscus-container :global(iframe.giscus-frame) {
            color-scheme: dark;
        }
        
        /* --- Mobile First (< 768px) --- */
        @media (max-width: 767px) {
            #giscus-container {
                padding: 1rem;
                border-radius: var(--radius-large);
            }
            
            #giscus-container :global(iframe.giscus-frame) {
                min-height: 300px;
            }
        }
        
        /* --- Tablets (768px - 1024px) --- */
        @media (min-width: 768px) and (max-width: 1024px) {
            #giscus-container {
                padding: 1.5rem;
            }
            
            #giscus-container :global(iframe.giscus-frame) {
                min-height: 320px;
            }
        }
        
        /* --- Desktop (> 1024px) --- */
        @media (min-width: 1025px) {
            #giscus-container :global(iframe.giscus-frame) {
                min-height: 350px;
            }
        }
        
        /* --- Touch Optimizations (CR√çTICO PARA M√ìVIL) --- */
        @media (hover: none) and (pointer: coarse) {
            /* √Åreas t√°ctiles m√≠nimas de 44x44px (WCAG) */
            #giscus-container :global(button),
            #giscus-container :global(a),
            #giscus-container :global(input),
            #giscus-container :global(textarea) {
                min-height: 44px;
                min-width: 44px;
                padding: 0.75rem;
            }
            
            /* Mejor scrolling en m√≥vil */
            #giscus-container {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                overscroll-behavior: contain;
            }
            
            /* Prevenir zoom en inputs */
            #giscus-container :global(input),
            #giscus-container :global(textarea) {
                font-size: 16px !important; /* Previene auto-zoom en iOS */
            }
        }
        
        /* --- Accessibility: Reduced Motion --- */
        @media (prefers-reduced-motion: reduce) {
            #giscus-container,
            #giscus-container * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* --- Print --- */
        @media print {
            #giscus-container {
                display: none !important;
            }
        }
        
        /* --- Prevenir overflow --- */
        #giscus-container :global(*) {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* --- Loading Animation --- */
        #giscus-container [role="status"] {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* --- Manual Load Button --- */
        #giscus-manual-load {
            font-family: inherit;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #giscus-manual-load:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* --- Mejoras t√°ctiles para el bot√≥n --- */
        @media (hover: none) and (pointer: coarse) {
            #giscus-manual-load {
                min-height: 48px;
                font-size: 16px;
            }
        }
    </style>

</MainGridLayout>2
