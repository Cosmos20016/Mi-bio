<script>
        // ============================================
        // GISCUS COMMENTS - OPTIMIZADO
        // ============================================

        interface GiscusMessage {
            giscus: {
                setConfig: {
                    theme: string;
                };
            };
        }

        let giscusLoaded = false;
        let themeObserver: MutationObserver | null = null;
        let intersectionObserver: IntersectionObserver | null = null;
        let iframeObserver: MutationObserver | null = null;

        function isMobileDevice(): boolean {
            const ua = navigator.userAgent.toLowerCase();
            const isMobileUA = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
            const isSmallScreen = window.innerWidth < 768;
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            return isMobileUA || (isSmallScreen && isTouchDevice);
        }

        function getCurrentTheme(): string {
            return document.documentElement.classList.contains('dark')
                ? 'transparent_dark'
                : 'light';
        }

        /**
         * Espera el iframe con MutationObserver ‚Äî sin polling, reacci√≥n instant√°nea
         */
        function waitForGiscusIframe(): Promise<HTMLIFrameElement | null> {
            return new Promise((resolve) => {
                // Comprobaci√≥n inmediata por si ya existe
                const existing = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
                if (existing) {
                    resolve(existing);
                    return;
                }

                const container = document.getElementById('giscus-container');
                if (!container) {
                    resolve(null);
                    return;
                }

                // Timeout de seguridad: 5s m√°ximo
                const timeout = window.setTimeout(() => {
                    iframeObserver?.disconnect();
                    iframeObserver = null;
                    console.warn('[Giscus] ‚ö† Iframe timeout');
                    resolve(null);
                }, 5000);

                iframeObserver = new MutationObserver(() => {
                    const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
                    if (iframe) {
                        clearTimeout(timeout);
                        iframeObserver?.disconnect();
                        iframeObserver = null;
                        console.log('[Giscus] ‚úì Iframe detected');
                        resolve(iframe);
                    }
                });

                iframeObserver.observe(container, { childList: true, subtree: true });
            });
        }

        function setupThemeObserver(): void {
            themeObserver?.disconnect();

            themeObserver = new MutationObserver((mutations) => {
                const hasThemeChange = mutations.some(
                    m => m.type === 'attributes' && m.attributeName === 'class'
                );
                if (!hasThemeChange) return;

                const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
                if (!iframe?.contentWindow) return;

                const theme = getCurrentTheme();
                const message: GiscusMessage = {
                    giscus: { setConfig: { theme } }
                };

                try {
                    iframe.contentWindow.postMessage(
                        message,
                        'https://giscus-personal-woft.vercel.app'
                    );
                    console.log(`[Giscus] ‚úì Theme changed to: ${theme}`);
                } catch (e) {
                    console.error('[Giscus] Error sending theme message:', e);
                }
            });

            themeObserver.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['class']
            });

            console.log('[Giscus] ‚úì Theme observer active');
        }

        async function loadGiscus(): Promise<void> {
            if (giscusLoaded) return;

            const container = document.getElementById('giscus-container');
            if (!container) {
                console.warn('[Giscus] Container not found');
                return;
            }

            console.log(`[Giscus] üöÄ Loading on ${isMobileDevice() ? 'MOBILE' : 'DESKTOP'}`);

            const currentTheme = getCurrentTheme();

            const script = document.createElement('script');
            script.src = 'https://giscus-personal-woft.vercel.app/es/client.js';
            script.setAttribute('data-repo', 'Cosmos20016/Gestion-de-comentarios');
            script.setAttribute('data-repo-id', 'R_kgDOPSHLmA');
            script.setAttribute('data-category', 'Announcements');
            script.setAttribute('data-category-id', 'DIC_kwDOPSHLmM4CtXsZ');
            script.setAttribute('data-mapping', 'pathname');
            script.setAttribute('data-strict', '0');
            script.setAttribute('data-reactions-enabled', '1');
            script.setAttribute('data-emit-metadata', '0');
            script.setAttribute('data-input-position', 'bottom');
            script.setAttribute('data-theme', currentTheme);
            script.setAttribute('data-lang', 'es');
            // ELIMINADO: data-loading="lazy" ‚Äî ya manejamos lazy load con IntersectionObserver
            script.crossOrigin = 'anonymous';
            script.async = true;

            script.onerror = () => {
                console.error('[Giscus] ‚ùå Script load failed');
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-8 gap-3 text-red-500">
                        <span class="text-sm">Error al cargar comentarios</span>
                        <button onclick="location.reload()" class="text-xs underline hover:no-underline">
                            Recargar p√°gina
                        </button>
                    </div>
                `;
            };

            script.onload = async () => {
                console.log('[Giscus] ‚úì Script loaded');
                giscusLoaded = true;

                // MutationObserver reacciona en cuanto aparece el iframe ‚Äî sin polling
                const iframe = await waitForGiscusIframe();

                if (iframe) {
                    setupThemeObserver();
                    console.log('[Giscus] ‚úì Fully initialized');
                } else {
                    console.warn('[Giscus] ‚ö† Iframe not available');
                }
            };

            container.appendChild(script);
        }

        function isContainerVisible(): boolean {
            const container = document.getElementById('giscus-container');
            if (!container) return false;
            const rect = container.getBoundingClientRect();
            const windowHeight = window.innerHeight || document.documentElement.clientHeight;
            return rect.top < windowHeight + 200;
        }

        function initGiscusLoad(): void {
            const container = document.getElementById('giscus-container');
            if (!container) return;

            console.log('[Giscus] Initializing');

            if (isContainerVisible()) {
                console.log('[Giscus] Container already visible');
                loadGiscus();
                return;
            }

            intersectionObserver?.disconnect();

            const rootMargin = isMobileDevice() ? '150px' : '250px';

            intersectionObserver = new IntersectionObserver(
                (entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && !giscusLoaded) {
                            console.log('[Giscus] ‚úì Container intersecting');
                            loadGiscus();
                            intersectionObserver?.disconnect();
                        }
                    });
                },
                { rootMargin, threshold: 0.01 }
            );

            intersectionObserver.observe(container);
            console.log(`[Giscus] ‚úì Observer active (${rootMargin})`);
        }

        function cleanup(): void {
            console.log('[Giscus] Cleaning up');
            giscusLoaded = false;
            themeObserver?.disconnect();
            themeObserver = null;
            intersectionObserver?.disconnect();
            intersectionObserver = null;
            iframeObserver?.disconnect();
            iframeObserver = null;
        }

        function handlePageChange(): void {
            cleanup();
            setTimeout(() => initGiscusLoad(), 150);
        }

        function initSwupIntegration(): void {
            if (typeof window === 'undefined') return;

            if (window.swup?.hooks) {
                window.swup.hooks.on('page:view', handlePageChange);
                console.log('[Giscus] ‚úì Swup integration ready');
            } else {
                document.addEventListener('swup:enable', () => {
                    if (window.swup?.hooks) {
                        window.swup.hooks.on('page:view', handlePageChange);
                        console.log('[Giscus] ‚úì Swup integration ready (delayed)');
                    }
                }, { once: true });
            }
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initGiscusLoad();
                initSwupIntegration();
            });
        } else {
            initGiscusLoad();
            initSwupIntegration();
        }

        window.addEventListener('beforeunload', cleanup);

        let resizeTimer: number;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = window.setTimeout(() => {
                if (!giscusLoaded && isContainerVisible()) {
                    loadGiscus();
                }
            }, 500);
        });

        console.log('[Giscus] ‚úì Module initialized');
    </script>
